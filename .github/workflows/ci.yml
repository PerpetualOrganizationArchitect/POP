name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

jobs:
  foundry-cicd:
    uses: BreadchainCoop/etherform/.github/workflows/_foundry-cicd.yml@foundry-profile-input
    with:
      # CI Options
      check-formatting: true
      test-verbosity: 'vvv'

      # Upgrade Safety
      run-upgrade-safety: true
      baseline-path: 'upgrades/baseline'
      validation-script: 'script/upgrades/ValidateUpgrade.s.sol'

      # Automatic Deployments
      deploy-on-pr: false
      deploy-on-main: true
      deploy-script: 'script/DeployInfrastructure.s.sol:DeployInfrastructure'
      network-config-path: '.github/deploy-networks.json'
      indexing-wait: 90
      flatten-contracts: true
      upgrades-path: 'upgrades'
      deployment-foundry-profile: 'production'
    secrets:
      PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
      RPC_URL: ${{ secrets.HOODI_RPC_URL }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Auto-commit infrastructure.json after mainnet deployment
  commit-infrastructure:
    needs: foundry-cicd
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download deployment artifacts
        uses: actions/download-artifact@v4
        with:
          name: deployment-artifacts
          path: script/
        continue-on-error: true

      - name: Commit infrastructure.json if changed
        run: |
          if [ -f script/infrastructure.json ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add script/infrastructure.json
            if ! git diff --staged --quiet; then
              git commit -m "chore: update infrastructure.json [skip ci]"
              git pull --rebase origin main
              git push
            fi
          fi
